<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
* {box-sizing: border-box;}

.img-zoom-container {
  position: relative;
}

.img-zoom-lens {
  position: absolute;
  border: 1px solid #d4d4d4;
  /*set the size of the lens:*/
  width: 40px;
  height: 40px;
}

.img-zoom-result {
  border: 1px solid #d4d4d4;
  /*set the size of the result div:*/
  width: 300px;
  height: 300px;
}
.img-stack {
  border: 5px solid #1862d1;
  /*set the size of the result div:*/
  width: 600px;
  height: 300px;
}

</style>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js">
</script>

<script>

var lines = [];

function imageZoom(imgID, resultID) {
  var img, lens, result, cx, cy;
  img = document.getElementById(imgID);
  result = document.getElementById(resultID);
  /*create lens:*/
  lens = document.createElement("DIV");
  lens.setAttribute("class", "img-zoom-lens");
  /*insert lens:*/
  img.parentElement.insertBefore(lens, img);
  /*calculate the ratio between result DIV and lens:*/
  cx = result.offsetWidth / lens.offsetWidth;
  cy = result.offsetHeight / lens.offsetHeight;
  /*set background properties for the result DIV:*/
  result.style.backgroundImage = "url('" + img.src + "')";
  result.style.backgroundSize = (img.width * cx) + "px " + (img.height * cy) + "px";
  /*execute a function when someone moves the cursor over the image, or the lens:*/
  lens.addEventListener("mousemove", moveLens);
  img.addEventListener("mousemove", moveLens);
  /*and also for touch screens:*/
  lens.addEventListener("touchmove", moveLens);
  img.addEventListener("touchmove", moveLens);
  /* look for clicks */
  lens.addEventListener("mousedown", clickEmbryo);
  img.addEventListener("mousedown", clickEmbryo);


function clickEmbryo(e) 
{
    var pos, xval, yval, fname;
    var dists;
    var msgString = "default";

	  e.preventDefault();
    pos = getCursorPos(e);

    dists = [];
    minDist = 100000000;
    minDistIndex = -1;
    //msgString += "lines.length ="+String(lines.length)+"\n";
    msgString += "CLICK("+String(pos.x)+","+String(pos.y)+") ";
    
    for (var i=0; i<lines.length; i++) 
    {
      xval = Number(lines[i][1])/3;
      yval = Number(lines[i][2])/3;
       dx = xval - pos.x;
       dy = yval - pos.y;
       dsqrd = dx*dx + dy*dy;
       dist = Math.sqrt(dsqrd);
       dists.push(dist);
       if (i==0) {
         msgString += " Embryo zero is at "+xval+","+yval+","+dx+","+dy+" dsqrd="+dsqrd+" dist="+dist;
//         msgString += "xval="+String(xval)+" = "+String(dist)+"\n";
       }
       if (dist<minDist) {
         minDist=dist;
         minDistIndex = i;
       }
    }
    
    msgString += "Closest:"+String(minDistIndex)+"  "+String(minDist)+"\n";
   //msgString += "lines[0].x="+lines[0].x+" String_version =",String(lines[0].x);

    //msgString += "[0][0]="+lines[0][0]+"[0][1]="+lines[0][1]+" [1][3]"+lines[1][3];
    mymsg = document.getElementById("mymsg");
   // fname = lines[i].File
    //mymsg.textContent = "Closest embryo is "+String(minDistIndex)+"  "+fname
    mymsg.textContent = msgString;

	mymp4 = document.getElementById("my_mp4");
  mp4str = "images/mp4/"+lines[minDistIndex][0]+".mp4"
	mymp4.src = mp4str;
  mymsg.textContent = mp4str;
  myvideo = document.getElementById("my_video");
  myvideo.load();
}


  function moveLens(e) {
    var pos, x, y;
    /*prevent any other actions that may occur when moving over the image:*/
    e.preventDefault();
    /*get the cursor's x and y positions:*/
    pos = getCursorPos(e);
    /*calculate the position of the lens:*/
    x = pos.x - (lens.offsetWidth / 2);
    y = pos.y - (lens.offsetHeight / 2);
    /*prevent the lens from being positioned outside the image:*/
    if (x > img.width - lens.offsetWidth) {x = img.width - lens.offsetWidth;}
    if (x < 0) {x = 0;}
    if (y > img.height - lens.offsetHeight) {y = img.height - lens.offsetHeight;}
    if (y < 0) {y = 0;}
    /*set the position of the lens:*/
    lens.style.left = x + "px";
    lens.style.top = y + "px";
    /*display what the lens "sees":*/
    result.style.backgroundPosition = "-" + (x * cx) + "px -" + (y * cy) + "px";
  }
  function getCursorPos(e) {
    var a, x = 0, y = 0;
    e = e || window.event;
    /*get the x and y positions of the image:*/
    a = img.getBoundingClientRect();
    /*calculate the cursor's x and y coordinates, relative to the image:*/
    x = e.pageX - a.left;
    y = e.pageY - a.top;
    /*consider any page scrolling:*/
    x = x - window.pageXOffset;
    y = y - window.pageYOffset;
    return {x : x, y : y};
  }
}
  
  // Initiate zoom effect:
  $(document).ready(function() {
    
      $.ajax({
          type: "GET",
          url: "embryo_map_003.html",
          dataType: "text",
          success: function(data) {processData(data);}
       });
      /*
      $("p").click(function(){
        $(this).hide();
      });
      */
  });
  
  function processData(allText) {
      var allTextLines = allText.split(/\r\n|\n/);
      var headers = allTextLines[0].split(',');
  
      for (var i=1; i<allTextLines.length; i++) {
          var data = allTextLines[i].split(',');
          if (data.length == headers.length) {
  
              var tarr = [];
              for (var j=0; j<headers.length; j++) {
//                  tarr.push(headers[j]+":"+data[j]);
                  tarr.push(data[j]);
              }
              lines.push(tarr);
          }
      }
      // alert(lines);
    mymsg = document.getElementById("mymsg");
    mymsg.textContent = lines[1];
   
  }
</script>      
  
</head>
<body>

<h1>GENE30004 <em>Drosophila</em> Development Practical</h1>

<p>Use your mouse to move around the slide. Click on an embryo to get a close up view. Use the Channel buttons to see the colors separately:</p>

<div class="img-zoom-container">
  <table>
    <tr>
      <td colspan="2">
  <img id="myimage" src="images/slide_003.jpg" width="716" height="274">
</td>
</tr>
<tr>
  <td>
  <div id="myresult" class="img-zoom-result"></div>
  </td>
<td>
  <table>
    <tr>
      <td> Embryo ID </td>
      <td><button type="button">betaGAL</button></td>
      <td><button type="button">EVE</button></td>
      <td><button type="button">BOTH</button></td>
    </tr>
    <tr>
  <video id = "my_video" width="320" height="240" controls autoplay>
    <source id="my_mp4" src="images/mp4/stg5.mp4" type="video/mp4">
    Your browser does not support the video tag.
  </video>
  </tr>
</table>
</td>
</tr>
<tr>
  <td colspan="2"> 
  <p id="mymsg">default mmessage</p>
</td>
</tr>
</table>
  </div>

  <script>
  imageZoom("myimage", "myresult");
  </script>

<video id = "my_video" width="320" height="240" controls autoplay>
  <source id="my_mp4" src="images/mp4/emb0.mp4" type="video/mp4">
    Your browser does not support the video tag.
</video>

</body>
</html>
