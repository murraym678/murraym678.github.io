<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="gene30004.css">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js">
</script>

<script>

var lines = [];
var channels = 2; // 0=bgal, 1=eve, 2=both
var currEmbryoId = 0;
var mouseDown = false;
var mp4_ok = true;



function changeVideo()
{
  // called when embryo changes, or mp4/gif, or channel
  if (mp4_ok){
    if (channels==0) {
      animStr = "images/mp4/C1-"+lines[currEmbryoId][0]+".mp4"
    } else if (channels==1) {
      animStr = "images/mp4/C2-"+lines[currEmbryoId][0]+".mp4"
    } else {  // channels must be 2
      animStr = "images/mp4/"+lines[currEmbryoId][0]+".mp4"
    }
    myMp4 = document.getElementById("my_mp4");
  	myMp4.src = animStr;
//    mymsg.textContent = animStr;
    myVideo = document.getElementById("my_video");
    myVideo.load();  
  } else { // have to use the gifs
    if (channels==0) {
      gifStr = "images/gif/C1-"+lines[currEmbryoId][0]+".gif"
    } else if (channels==1) {
      gifStr = "images/gif/C2-"+lines[currEmbryoId][0]+".gif"
    } else {  // channels must be 2
      gifStr = "images/gif/"+lines[currEmbryoId][0]+".gif"
    }
    myGif = document.getElementById("my_gif");
  	myGif.src = gifStr;
    //mymsg.textContent = gifStr;
  }
}


function imageZoom(imgID, resultID) {

  var img, lens, result, cx, cy;
  img = document.getElementById(imgID);
  result = document.getElementById(resultID);
  /*create lens:*/
  lens = document.createElement("DIV");
  lens.setAttribute("class", "img-zoom-lens");
  /*insert lens:*/
  img.parentElement.insertBefore(lens, img);
  /*calculate the ratio between result DIV and lens:*/
  cx = result.offsetWidth / lens.offsetWidth;
  cy = result.offsetHeight / lens.offsetHeight;
  /*set background properties for the result DIV:*/
  result.style.backgroundImage = "url('" + img.src + "')";
  result.style.backgroundSize = (img.width * cx) + "px " + (img.height * cy) + "px";
  /*execute a function when someone moves the cursor over the image, or the lens:*/
  lens.addEventListener("mousemove", moveLens);
  img.addEventListener("mousemove", moveLens);
  /*and also for touch screens:*/
  lens.addEventListener("touchmove", moveLens);
  img.addEventListener("touchmove", moveLens);
  /* look for clicks */
  lens.addEventListener("mousedown", clickEmbryo);
  img.addEventListener("mousedown", clickEmbryo);
  lens.addEventListener("mouseup", clickEmbryo);
  img.addEventListener("mouseup", clickEmbryo);



  function clickEmbryo(e) 
{
    var pos, xval, yval, fname;
    var dists;
    var msgString = "default";

    if (!mouseDown) {
      mouseDown = true;
      moveLens(e);
      return;
    }
    mouseDown = false; // was down and now released so pick an embryo

	  e.preventDefault();
    pos = getCursorPos(e);

    dists = [];
    minDist = 100000000;
    minDistIndex = -1;
    //msgString += "lines.length ="+String(lines.length)+"\n";
    msgString += "CLICK("+String(pos.x)+","+String(pos.y)+") ";
    
    for (var i=0; i<lines.length; i++) 
    {
      xval = Number(lines[i][1])/8;
      yval = Number(lines[i][2])/8;
       dx = xval - pos.x;
       dy = yval - pos.y;
       dsqrd = dx*dx + dy*dy;
       dist = Math.sqrt(dsqrd);
       dists.push(dist);
       
       if (i==0) {
         msgString += " Embryo zero is at "+xval+","+yval+","+dx+","+dy+" dsqrd="+dsqrd+" dist="+dist;
//         msgString += "xval="+String(xval)+" = "+String(dist)+"\n";
       }
       
       if (dist<minDist) {
         minDist=dist;
         minDistIndex = i;
       }
    }
    
    msgString += "Closest:"+String(minDistIndex)+"  "+String(minDist)+"\n";
   //msgString += "lines[0].x="+lines[0].x+" String_version =",String(lines[0].x);

    //msgString += "[0][0]="+lines[0][0]+"[0][1]="+lines[0][1]+" [1][3]"+lines[1][3];
    //mymsg = document.getElementById("mymsg");
   // fname = lines[i].File
    //mymsg.textContent = "Closest embryo is "+String(minDistIndex)+"  "+fname
    //mymsg.textContent = msgString;
    currEmbryoId = minDistIndex;
    embIdMsg = document.getElementById("EmbryoID");
    embIdMsg.textContent = "Embryo ID:"+String(minDistIndex);
}


  function moveLens(e) {
    var pos, x, y;

    if (!mouseDown) { // only move the box when the mouse is down.
      return;
    }
    /*prevent any other actions that may occur when moving over the image:*/
    e.preventDefault();
    /*get the cursor's x and y positions:*/
    pos = getCursorPos(e);
    /*calculate the position of the lens:*/
    x = pos.x - (lens.offsetWidth/2);
    y = pos.y - (lens.offsetHeight/2);
    /*prevent the lens from being positioned outside the image:*/
    if (x > img.width - lens.offsetWidth) {x = img.width - lens.offsetWidth;}
    if (x < 0) {x = 0;}
    if (y > img.height - lens.offsetHeight) {y = img.height - lens.offsetHeight;}
    if (y < 0) {y = 0;}
    /*set the position of the lens:*/
    lens.style.left = x + "px";
    lens.style.top = y + "px";
    /*display what the lens "sees":*/
    result.style.backgroundPosition = "-" + (x * cx) + "px -" + (y * cy) + "px";
  }

  function getCursorPos(e) {
    var a, x = 0, y = 0;
    e = e || window.event;
    /*get the x and y positions of the image:*/
    a = img.getBoundingClientRect();
    /*calculate the cursor's x and y coordinates, relative to the image:*/
    x = e.pageX - a.left;
    y = e.pageY - a.top;
    /*consider any page scrolling:*/
    x = x - window.pageXOffset;
    y = y - window.pageYOffset;
    return {x : x, y : y};
  }
  }
  
  // Initiate zoom effect:
  $(document).ready(function() 
  {
    //alert("Calling ready function");
     digitStr = location.search.charAt(location.search.length-1);
      urlStr = "images/slides_and_maps/genotypeB_eve_bgal_"+digitStr+"_embryo_map.html";
      //alert("THE MAP IS AT "+urlStr);

      $.ajax({
          type: "GET",
          url: urlStr,
          dataType: "text",
          success: function(data) {processData(data);}
       });
       myimg = document.getElementById("myimage");
       srcStr = "images/slides_and_maps/genotypeB_eve_bgal_"+digitStr+".jpg";
       //alert("THE NEW SLIDE IMAGE IS "+srcStr);       
       myimg.src = srcStr;

      result = document.getElementById("myresult");
      result.style.backgroundImage = "url('" + myimg.src + "')";

      slide_id = document.getElementById("slide_id");
      slide_id.textContent = "Slide for student:"+location.search.substring(1,location.search.length);

  });
  
  function processData(allText) {
      var allTextLines = allText.split(/\r\n|\n/);
      var headers = allTextLines[0].split(',');
  
      for (var i=1; i<allTextLines.length; i++) {
          var data = allTextLines[i].split(',');
          if (data.length == headers.length) {
  
              var tarr = [];
              for (var j=0; j<headers.length; j++) {
//                  tarr.push(headers[j]+":"+data[j]);
                  tarr.push(data[j]);
              }
              lines.push(tarr);
          }
      }
      // alert(lines);
    //mymsg = document.getElementById("mymsg");
    //mymsg.textContent = lines[1];
    //mymsg.textContent = location.search;
   
  }

  
  </script>      
  
</head>
<body>

<h1>GENE30004 Practical - SLIDE 4</h1>
<p class="TASK">TASK: Examine the embryos below to determine the identity of gene 3.</p>
<div class="GENOTYPE_STAIN">
  <h4>genotype B  =  gene3<sup>-</sup> / TM3 <sub>gene4-regulatory-element::lacZ </sub> </h4>
  <h4>1˚: Mouse-anti-EVE + Chicken-anti-betaGal</h4>
  <h4>2˚: Goat-anti-mouse-Alexa488 + Donkey-anti-Chicken-AP</h4>
  <h4> &nbsp</h4>
  </div>
<div class="EXPLANATION">
<p>This virtual slide shows embryos of genotypeB immunostained with a beta-galactosidase primary antibody. 
  The secondary antibody is congugated to Alkaline Phosphatase (AP) which is producing a dark reaction product.</p>
<p>Hence, the dark stain shows you where the lacZ gene is being expressed.
  Since the lacZ gene is under the control of the regulatory region of gene4
  it should recapitulate the expression pattern of the gene4 (it may not be exactly the same).</p>

  <p>Use your mouse to move the box around the slide. 
    The embryo under the box will be shown in more detail below. 
    Use the Channel buttons to see the bgal or eve stains , or see both together.</p>
    <p>You will need to include snapshots of some of these embryos for your report. 
      Make sure you also include the Embryo ID:. </p>
  </div>
  <h2 id="slide_id"> Slide for student: </h2>
<div class="img-zoom-container">
  <img id="myimage" src="images/slides_and_maps/genotypeB_eve_bgal_0.jpg" width="500" height="188">
  <h1 id="EmbryoID">Embryo ID:</h1>
  <div id="myresult" class="img-zoom-result"></div>
</div>

  <script>
//    alert("Calling imageZoom");
  imageZoom("myimage", "myresult");
  //mm = document.getElementById("mymsg");
  //mm.text = location.search;
  </script>

</body>
</html>
